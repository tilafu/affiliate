<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auth Test Page</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-md-8 mx-auto">
                <div class="card">
                    <div class="card-header">
                        <h3>Authentication Test Page</h3>
                    </div>
                    <div class="card-body">
                        <p>This page tests the authentication system. If you see this content, authentication passed.</p>
                        
                        <div class="alert alert-info">
                            <strong>Test Instructions:</strong>
                            <ul>
                                <li>If you're not logged in, you should be redirected to login.html</li>
                                <li>If your session expires, you should be redirected automatically</li>
                                <li>Check the browser console for authentication logs</li>
                            </ul>
                        </div>

                        <h5>Authentication Status:</h5>
                        <div id="auth-status" class="alert alert-secondary">
                            Loading...
                        </div>

                        <div class="row mt-3">
                            <div class="col-md-6">
                                <button class="btn btn-primary" onclick="testApiCall()">Test API Call</button>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-warning" onclick="clearAuthData()">Clear Auth & Test Redirect</button>
                            </div>
                        </div>

                        <div class="mt-3">
                            <a href="home.html" class="btn btn-secondary">Back to Home</a>
                            <a href="account.html" class="btn btn-info">Go to Account</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="./js/main.js"></script>
    <script src="./js/auth-check.js"></script>
    <script src="./js/auth-guard.js"></script>

    <script>
        // Test the authentication system
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('=== AUTH TEST PAGE LOADED ===');
            
            try {
                // Test the enhanced authentication guard
                const authResult = await protectPage({
                    requireAdmin: false,
                    pageTitle: 'Auth Test Page',
                    enableMonitoring: true,
                    monitoringInterval: 1, // Check every minute for testing
                    onAuthSuccess: function(authData) {
                        console.log('Auth test successful:', authData);
                        updateAuthStatus('✅ Authentication Successful', 'success', authData);
                    },
                    onAuthFailure: function() {
                        console.log('Auth test failed');
                        updateAuthStatus('❌ Authentication Failed - Should redirect soon', 'danger');
                    }
                });

                if (!authResult) {
                    updateAuthStatus('❌ Authentication Failed - Redirecting...', 'danger');
                }

            } catch (error) {
                console.error('Auth test error:', error);
                updateAuthStatus('❌ Authentication Error: ' + error.message, 'danger');
            }
        });

        function updateAuthStatus(message, type, authData = null) {
            const statusDiv = document.getElementById('auth-status');
            statusDiv.className = `alert alert-${type}`;
            statusDiv.innerHTML = message;

            if (authData) {
                statusDiv.innerHTML += `
                    <hr>
                    <small>
                        <strong>User:</strong> ${authData.user.username || 'Unknown'}<br>
                        <strong>Admin:</strong> ${authData.isAdmin ? 'Yes' : 'No'}<br>
                        <strong>Token:</strong> ${authData.token ? 'Present' : 'Missing'}
                    </small>
                `;
            }
        }

        function testApiCall() {
            console.log('Testing API call...');
            
            // Test the authenticated fetch
            if (typeof fetchWithAuth === 'function') {
                fetchWithAuth('/api/user/profile')
                    .then(data => {
                        console.log('API call successful:', data);
                        showNotification('API call successful!', 'success');
                    })
                    .catch(error => {
                        console.error('API call failed:', error);
                        showNotification('API call failed: ' + error.message, 'error');
                    });
            } else {
                showNotification('fetchWithAuth function not available', 'error');
            }
        }

        function clearAuthData() {
            console.log('Clearing authentication data for testing...');
            
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user_data');
            localStorage.removeItem('admin_auth_token');
            
            showNotification('Auth data cleared. Page should redirect in a few seconds...', 'warning');
            
            // Trigger auth check after clearing data
            setTimeout(() => {
                const authResult = requireAuth(false);
                if (!authResult) {
                    updateAuthStatus('❌ Auth cleared - should redirect', 'warning');
                }
            }, 1000);
        }

        // Simple notification function if main.js version isn't available
        if (typeof showNotification !== 'function') {
            window.showNotification = function(message, type) {
                console.log(`[${type.toUpperCase()}] ${message}`);
                alert(`${type.toUpperCase()}: ${message}`);
            };
        }
    </script>
</body>
</html>
